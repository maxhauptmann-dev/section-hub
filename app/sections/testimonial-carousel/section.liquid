{% comment %}
  Section Hub - Testimonial Carousel
  Modernes Testimonial-Karussell mit Autoplay und manueller Navigation.
{% endcomment %}

{{ 'section-testimonial-carousel.css' | asset_url | stylesheet_tag }}

<section class="testimonial-carousel" style="
  --tc-bg: {{ section.settings.background_color }};
  --tc-text: {{ section.settings.text_color }};
  --tc-accent: {{ section.settings.accent_color }};
  --tc-card-bg: {{ section.settings.card_background }};
">
  <div class="testimonial-carousel__container">
    {% if section.settings.heading != blank %}
      <div class="testimonial-carousel__header">
        {% if section.settings.eyebrow != blank %}
          <span class="testimonial-carousel__eyebrow">{{ section.settings.eyebrow }}</span>
        {% endif %}
        <h2 class="testimonial-carousel__heading">{{ section.settings.heading }}</h2>
      </div>
    {% endif %}

    <div class="testimonial-carousel__track" id="testimonial-track-{{ section.id }}">
      {% for block in section.blocks %}
        <div class="testimonial-carousel__card" {{ block.shopify_attributes }}>
          <div class="testimonial-carousel__stars">
            {% for i in (1..5) %}
              {% if i <= block.settings.rating %}
                <svg width="20" height="20" viewBox="0 0 20 20" fill="var(--tc-accent)">
                  <path d="M10 1L12.39 6.26L18 7.27L14 11.14L14.76 17L10 14.27L5.24 17L6 11.14L2 7.27L7.61 6.26L10 1Z"/>
                </svg>
              {% else %}
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="var(--tc-accent)" stroke-width="1.5">
                  <path d="M10 1L12.39 6.26L18 7.27L14 11.14L14.76 17L10 14.27L5.24 17L6 11.14L2 7.27L7.61 6.26L10 1Z"/>
                </svg>
              {% endif %}
            {% endfor %}
          </div>
          
          <blockquote class="testimonial-carousel__quote">
            {{ block.settings.quote }}
          </blockquote>
          
          <div class="testimonial-carousel__author">
            {% if block.settings.avatar != blank %}
              <img 
                src="{{ block.settings.avatar | image_url: width: 80 }}" 
                alt="{{ block.settings.name }}"
                class="testimonial-carousel__avatar"
                width="48"
                height="48"
                loading="lazy"
              >
            {% else %}
              <div class="testimonial-carousel__avatar-placeholder">
                {{ block.settings.name | slice: 0 }}
              </div>
            {% endif %}
            <div>
              <div class="testimonial-carousel__name">{{ block.settings.name }}</div>
              {% if block.settings.title != blank %}
                <div class="testimonial-carousel__title">{{ block.settings.title }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="testimonial-carousel__nav">
      <button class="testimonial-carousel__btn testimonial-carousel__btn--prev" aria-label="Vorheriges">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="testimonial-carousel__dots" id="testimonial-dots-{{ section.id }}">
        {% for block in section.blocks %}
          <button class="testimonial-carousel__dot {% if forloop.first %}active{% endif %}" data-index="{{ forloop.index0 }}" aria-label="Testimonial {{ forloop.index }}"></button>
        {% endfor %}
      </div>
      <button class="testimonial-carousel__btn testimonial-carousel__btn--next" aria-label="Nächstes">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</section>

<script>
(function() {
  const section = document.querySelector('.testimonial-carousel');
  const track = document.getElementById('testimonial-track-{{ section.id }}');
  const dots = document.querySelectorAll('#testimonial-dots-{{ section.id }} .testimonial-carousel__dot');
  const prevBtn = section.querySelector('.testimonial-carousel__btn--prev');
  const nextBtn = section.querySelector('.testimonial-carousel__btn--next');
  const cards = track.querySelectorAll('.testimonial-carousel__card');
  
  let current = 0;
  const total = cards.length;
  
  function goTo(index) {
    current = (index + total) % total;
    track.style.transform = `translateX(-${current * 100}%)`;
    dots.forEach((dot, i) => dot.classList.toggle('active', i === current));
  }
  
  prevBtn.addEventListener('click', () => goTo(current - 1));
  nextBtn.addEventListener('click', () => goTo(current + 1));
  dots.forEach((dot) => {
    dot.addEventListener('click', () => goTo(parseInt(dot.dataset.index)));
  });
  
  // Autoplay
  {% if section.settings.autoplay %}
  let interval = setInterval(() => goTo(current + 1), {{ section.settings.autoplay_speed }}000);
  section.addEventListener('mouseenter', () => clearInterval(interval));
  section.addEventListener('mouseleave', () => {
    interval = setInterval(() => goTo(current + 1), {{ section.settings.autoplay_speed }}000);
  });
  {% endif %}
})();
</script>

{% schema %}
{
  "name": "Testimonial Carousel",
  "tag": "section",
  "class": "section-testimonial-carousel",
  "settings": [
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow Text",
      "default": "Kundenstimmen"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Überschrift",
      "default": "Was unsere Kunden sagen"
    },
    {
      "type": "header",
      "content": "Farben"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Hintergrundfarbe",
      "default": "#0f172a"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Textfarbe",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Akzentfarbe (Sterne)",
      "default": "#fbbf24"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Karten-Hintergrund",
      "default": "#1e293b"
    },
    {
      "type": "header",
      "content": "Autoplay"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Automatisch abspielen",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay Geschwindigkeit",
      "default": 5
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "label": "Bewertung",
          "default": 5
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Zitat",
          "default": "Absolut begeistert! Die Qualität hat meine Erwartungen übertroffen. Kann ich nur weiterempfehlen."
        },
        {
          "type": "text",
          "id": "name",
          "label": "Name",
          "default": "Anna M."
        },
        {
          "type": "text",
          "id": "title",
          "label": "Titel/Position",
          "default": "Verifizierter Käufer"
        },
        {
          "type": "image_picker",
          "id": "avatar",
          "label": "Avatar"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonial Carousel",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "rating": 5,
            "quote": "Absolut begeistert! Die Qualität hat meine Erwartungen übertroffen. Schneller Versand und top Kundenservice.",
            "name": "Anna M.",
            "title": "Verifizierter Käufer"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "rating": 5,
            "quote": "Habe schon mehrfach bestellt und war jedes Mal zufrieden. Preis-Leistung stimmt einfach!",
            "name": "Thomas K.",
            "title": "Stammkunde"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "rating": 4,
            "quote": "Sehr schöne Produkte und liebevolle Verpackung. Wird definitiv nicht meine letzte Bestellung sein.",
            "name": "Sarah L.",
            "title": "Verifizierter Käufer"
          }
        }
      ]
    }
  ]
}
{% endschema %}
